{% extends 'base.html' %}

{% block title %}Taxi Tracker - Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚{% endblock %}

{% block styles %}
<style>
    /* ÎšÎ»Î¬ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï„Î¿Ï… Î¼Î®Î½Î± */
    .month-total-zero { color: var(--success-color); }
    .month-total-nonzero { color: var(--danger-color); }

    /* ÎšÎ»Î¬ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î¹Ï‚ Î¿Ï†ÎµÎ¹Î»Î­Ï‚ */
    .debt-pending {
        background-color: #fff3cd;
        border-color: #ffeeba;
    }
    .debt-paid {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    .debt-unpaid {
        background-color: #fff3cd;
        border-color: #ffeeba;
    }

    /* Extra Styles Î³Î¹Î± Credits */
    .result-box {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #eee;
    }
    .result-val { font-size: 2em; font-weight: bold; margin-top: 5px; }
    .ok { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

    .debt-item {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #eee;
    }
    
    .btn-pay {
        background-color: var(--success-color);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }

    .small-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .form-group { margin-bottom: 15px; }
    
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    
    select, input, input[type="date"], input[type="month"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }
    
    .grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    h2 { margin-top: 0; color: var(--secondary-color); font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
</style>
{% endblock %}

{% block content %}
    <!-- Î¤Î¯Ï„Î»Î¿Ï‚ -->
    <h1><span class="material-icons" style="color: #f39c12; font-size: 36px; vertical-align: middle;">token</span> Credits</h1>

    <!-- Î•Ï€Î¹Î»Î¿Î³Î® Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ - Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— margin-bottom: 30px -->
    <div class="card" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px;">
        <span style="font-weight: 500; font-size: 1.1em;">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î•Î»Î­Î³Ï‡Î¿Ï…:</span>
        <form action="{{ url_for('credits.credits_check') }}" method="GET" style="display: flex; gap: 10px;">
            <input type="date" name="date" value="{{ date }}" onchange="this.form.submit()" style="width: auto;">
            <input type="hidden" name="month" value="{{ selected_month }}">
        </form>
    </div>

    <div class="grid-layout">
        
        <!-- Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ® Î£Ï„Î®Î»Î·: Î¦ÏŒÏÎ¼Î± Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï -->
        <div class="card">
            <h2><span class="material-icons">calculate</span> Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î¤Î±Î¼ÎµÎ¯Î¿Ï…</h2>
            
            <form action="{{ url_for('credits.credits_check') }}" method="POST">
                <input type="hidden" name="date" value="{{ date }}">
            
                <div class="small-grid">
                    <div class="form-group">
                        <label>ğŸŒ… ÎˆÎ½Î±ÏÎ¾Î· (Î ÏÏ‰Î¯)</label>
                        <input type="number" name="start_balance" value="{{ log['start_balance'] if log else '' }}" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>ğŸŒƒ Î›Î®Î¾Î· (Î’ÏÎ¬Î´Ï…)</label>
                        <input type="number" name="end_balance" value="{{ log['end_balance'] if log else '' }}" placeholder="0" required>
                    </div>
                </div>

                <div class="small-grid">
                    <div class="form-group">
                        <label>â• Î‘Î³Î¿ÏÎ¬ Credits</label>
                        <input type="number" name="added_credits" id="added" value="{{ log['added_credits'] if log else '' }}" placeholder="0" oninput="toggleDebtField()">
                    </div>
                    <div class="form-group">
                        <label>âš–ï¸ Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· (+/-)</label>
                        <input type="number" name="correction" value="{{ log['correction'] if log else '' }}" placeholder="0">
                    </div>
                </div>

                <!-- Î ÎµÎ´Î¯Î± Î³Î¹Î± Î§ÏÎ­Î¿Ï‚ (Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Î±Î½ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ Credits) -->
                {% set display_style = 'block' if log and log['added_credits'] > 0 else 'none' %}
                <div id="debt-fields" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
                    <div class="form-group">
                        <label>ğŸ‘¤ Î Î¿Î¹Î¿Ï‚ Î­Î²Î±Î»Îµ;</label>
                        <input type="text" name="debt_source" value="{{ log['debt_source'] if log else '' }}" placeholder="ÎŒÎ½Î¿Î¼Î± (Ï€.Ï‡. Î“Î¹ÏÏÎ³Î¿Ï‚)">
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="paid" name="is_paid" style="width: auto;">
                        <label for="paid" style="margin:0; cursor:pointer;">Î•Î¯Î½Î±Î¹ Î®Î´Î· Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î¿;</label>
                    </div>
                </div>

                
                {% if log %}
                <div class="small-grid">
                    <button type="submit" name="save_log" value="1" class="btn-primary" style="background-color: var(--secondary-color);">
                        <span class="material-icons">save</span> Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·
                    </button>
                    <button type="submit" name="delete_log" value="1" class="btn-primary" style="background-color: var(--danger-color);" formnovalidate onclick="return confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ³Î³ÏÎ±Ï†Î®;')">
                        <span class="material-icons">delete</span> Î”Î¹Î±Î³ÏÎ±Ï†Î®
                    </button>
                </div>
                {% else %}
                <button type="submit" name="save_log" value="1" class="btn-primary" style="background-color: var(--secondary-color);">
                    <span class="material-icons">save</span> Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
                </button>
                {% endif %}
            </form>

            {% if log %}
            <div class="result-box {{ 'ok' if diff == 0 else 'error' }}">
                <div style="font-size: 1em; opacity: 0.8;">Credits Î”Î¹Î±Î´ÏÎ¿Î¼ÏÎ½: <b>{{ rides_credits }}</b></div>
                <hr style="border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 10px 0;">
                <div style="font-size: 1.1em;">Î”Î¹Î±Ï†Î¿ÏÎ¬ Î¤Î±Î¼ÎµÎ¯Î¿Ï…:</div>
                <div class="result-val">{{ diff }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Î”ÎµÎ¾Î¹Î¬ Î£Ï„Î®Î»Î·: Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎœÎ®Î½Î± -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2><span class="material-icons">calendar_today</span> Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎœÎ®Î½Î±</h2>
                <form action="{{ url_for('credits.credits_check') }}" method="GET">
                    <input type="hidden" name="date" value="{{ date }}">
                    <input type="month" name="month" value="{{ selected_month }}" onchange="this.form.submit()" style="padding: 5px; width: auto;">
                </form>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Î—Î¼/Î½Î¯Î±</th>
                            <th style="text-align: center;">ÎˆÎ½Î±ÏÎ¾Î·</th>
                            <th style="text-align: center;">Î›Î®Î¾Î·</th>
                            <th style="text-align: center;">Extras</th>
                            <th style="text-align: center;">Î”Î¹Î±Ï†.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in history %}
                        <tr>
                            <td>{{ day['date'].split('-')[2] }}/{{ day['date'].split('-')[1] }}</td>
                            <td style="text-align: center;">{{ day['start'] }}</td>
                            <td style="text-align: center;">{{ day['end'] }}</td>
                            <td class="{{ 'month-total-zero' if total_month_diff == 0 else 'month-total-nonzero' }}" 
                                style="text-align: center;">
                                {{ total_month_diff | int }}
                            </td>
                            <td class="{{ 'month-total-zero' if day['diff'] == 0 else 'month-total-nonzero' }}" 
                                style="text-align: center; font-weight: bold;">
                                {{ day['diff'] | int }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background-color: #f1f1f1; font-weight: bold;">
                            <td colspan="4" style="text-align: right;">Î£ÏÎ½Î¿Î»Î¿:</td>
                            <td class="{{ 'month-total-zero' if total_month_diff == 0 else 'month-total-nonzero' }}" style="text-align: center;">
                                {{ total_month_diff | int }}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% if not history %}
            <p style="text-align: center; color: #999; padding: 20px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</p>
            {% endif %}
        </div>

    </div> <!-- End Grid Layout -->

    <!-- ÎŸÏ†ÎµÎ¹Î»Î­Ï‚ (ÎšÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ Grid) -->
    {% if debts %}
    <div class="card" style="border-left: 5px solid var(--accent-color);">
        <h2><span class="material-icons">payments</span> Î•ÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„ÎµÏ‚ Î‘Î³Î¿ÏÏÎ½</h2>
        {% for debt in debts %}
        <div class="debt-item {{ 'debt-paid' if debt['is_paid'] else 'debt-pending' }}">
            <div>
                <strong style="color: var(--primary-color);">{{ debt['date'].split('-')[2] }}/{{ debt['date'].split('-')[1] }}</strong>
                <div style="font-size: 0.95em; margin-top: 5px;">
                    {{ debt['added_credits'] }} Credits Î±Ï€ÏŒ <b>{{ debt['debt_source'] }}</b>
                </div>
            </div>
            
            {% if debt['is_paid'] %}
                <span style="color: var(--success-color); font-weight: bold; display: flex; align-items: center; gap: 5px;">
                    <span class="material-icons">check_circle</span> Î•Î¾Î¿Ï†Î»Î®Î¸Î·ÎºÎµ
                </span>
            {% else %}
                <form action="{{ url_for('credits.credits_check') }}" method="POST">
                    <input type="hidden" name="pay_debt" value="1">
                    <input type="hidden" name="log_id" value="{{ debt['id'] }}">
                    <button type="submit" class="btn-pay" onclick="return confirm('Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚;')">Î•Î¾ÏŒÏ†Î»Î·ÏƒÎ·</button>
                </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    function toggleDebtField() {
        var added = document.getElementById('added').value;
        var debtDiv = document.getElementById('debt-fields');
        if (added && parseInt(added) > 0) {
            debtDiv.style.display = 'block';
        } else {
            debtDiv.style.display = 'none';
        }
    }

    // Î‘Ï…Ï„ÏŒ Î¸Î± Ï„ÏÎ­Î¾ÎµÎ¹ Î¼ÏŒÎ»Î¹Ï‚ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Î· ÏƒÎµÎ»Î¯Î´Î± ÎºÎ±Î¹ Î¸Î± ÎºÏÏÏˆÎµÎ¹/Î´ÎµÎ¯Î¾ÎµÎ¹ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ ÏƒÏ‰ÏƒÏ„Î¬
    document.addEventListener("DOMContentLoaded", function() {
        var addedInput = document.getElementById('added');
        var debtDiv = document.getElementById('debt-fields');
        if (addedInput && debtDiv) {
            debtDiv.style.display = (parseInt(addedInput.value) > 0) ? 'block' : 'none'; 
        }
    });
</script>
{% endblock %}
