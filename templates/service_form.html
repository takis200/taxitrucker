{% extends "base.html" %}

{% block title %}Taxi Tracker - {{ 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±' if service else 'ÎÎ­Î¿' }} Service{% endblock %}

{% block styles %}
<style>
    .service-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 25px;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
    
    /* Input Styling */
    .form-control, select, textarea, input[type="text"], input[type="number"], input[type="date"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box; /* Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¾ÎµÏ‡ÎµÎ¹Î»Î¯Î¶ÎµÎ¹ */
    }
    
    .form-control:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }

    /* Table Styling */
    .lines-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
    .lines-table th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600; }
    .lines-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
    
    /* Buttons */
    .btn-save { background: #27ae60; color: white; padding: 12px 25px; border: none; cursor: pointer; font-size: 16px; border-radius: 6px; font-weight: bold; transition: background 0.2s; }
    .btn-save:hover { background: #219150; }
    
    .btn-danger { background: #e74c3c; color: white; padding: 10px 15px; text-decoration: none; border-radius: 6px; font-weight: 500; display: inline-block; transition: background 0.2s; }
    .btn-danger:hover { background: #c0392b; }
    
    .btn-add { background: #3498db; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 6px; font-weight: 500; margin-top: 15px; display: inline-flex; align-items: center; gap: 5px; }
    .btn-add:hover { background: #2980b9; }

    .btn-cancel { color: #7f8c8d; text-decoration: none; font-weight: 500; padding: 10px 15px; }
    .btn-cancel:hover { color: #34495e; }

    /* Delete Row Button */
    .btn-del-row { background: none; border: none; cursor: pointer; color: #e74c3c; font-size: 1.2em; padding: 5px; border-radius: 4px; }
    .btn-del-row:hover { background-color: #ffeaea; }
</style>
{% endblock %}

{% block content %}
<div class="service-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="margin:0;">{{ 'âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±' if service else 'â• ÎÎ­Î¿' }} Service</h1>
        <a href="{{ url_for('services.services_list') }}" class="btn-cancel">ğŸ”™ Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</a>
    </div>
    
    <form method="POST">
        <!-- Header Fields -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="form-group" style="flex:1; min-width: 200px;">
                <label>ğŸ“… Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
                <input type="date" name="service_date" required value="{{ service.service_date if service else '' }}">
            </div>
            <div class="form-group" style="flex:1; min-width: 200px;">
                <label>ğŸš— Î§Î¹Î»Î¹ÏŒÎ¼ÎµÏ„ÏÎ± (Odometer)</label>
                <input type="number" name="odometer_km" required value="{{ service.odometer_km if service else '' }}">
            </div>
        </div>

        <div class="form-group">
            <label>ğŸ¢ Î£Ï…Î½ÎµÏÎ³ÎµÎ¯Î¿</label>
            <!-- Î‘Î»Î»Î±Î³Î® ÏƒÎµ Select Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î® Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î± -->
            <select name="workshop_name" class="form-control" required>
                <option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÏ…Î½ÎµÏÎ³ÎµÎ¯Î¿...</option>
                {% for w in workshops %}
                    <option value="{{ w.name }}" {% if service and service.workshop_name == w.name %}selected{% endif %}>
                        {{ w.name }}
                    </option>
                {% endfor %}
                <option value="custom">Î†Î»Î»Î¿ (Î³ÏÎ¬ÏˆÏ„Îµ ÏƒÏ„Î¹Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚)</option>
            </select>
        </div>

        <div class="form-group">
            <label>ğŸ“ Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· (Ï€.Ï‡. Î•Î³Î³ÏÎ·ÏƒÎ·, ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ service)</label>
            <textarea name="note" rows="3" class="form-control">{{ service.note if service else '' }}</textarea>
        </div>

        <!-- Parts Lines -->
        <h3 style="margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;">âš™ï¸ Î‘Î½Ï„Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ¬ & Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h3>
        <div class="table-responsive">
            <table class="lines-table" id="partsTable">
                <thead>
                    <tr>
                        <th width="15%">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</th>
                        <th width="40%">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
                        <th width="10%">Î Î¿Ïƒ.</th>
                        <th width="15%">Î¤Î¹Î¼Î® (â‚¬)</th>
                        <th width="10%"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in lines %}
                    <tr>
                        <!-- Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· list="parts_codes" Î³Î¹Î± autocomplete -->
                        <td><input type="text" name="part_code[]" value="{{ line.part_code }}" list="parts_codes" placeholder="ÎšÏ‰Î´."></td>
                        <!-- Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· list="parts_descriptions" Î³Î¹Î± autocomplete -->
                        <td><input type="text" name="part_description[]" value="{{ line.part_description }}" list="parts_descriptions" required placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®..."></td>
                        <td><input type="number" step="0.01" name="qty[]" value="{{ line.qty }}" required style="text-align: center;"></td>
                        <td><input type="number" step="0.01" name="unit_price[]" value="{{ line.unit_price }}" required></td>
                        <td style="text-align: center;"><button type="button" onclick="removeRow(this)" class="btn-del-row" title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î³ÏÎ±Î¼Î¼Î®Ï‚">ğŸ—‘ï¸</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <button type="button" class="btn-add" onclick="addRow()">
            <span>+</span> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î“ÏÎ±Î¼Î¼Î®Ï‚
        </button>

        <div class="form-group" style="margin-top: 25px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <label>ğŸ”§ ÎšÏŒÏƒÏ„Î¿Ï‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚ (Î•ÏÎ³Î±Ï„Î¹ÎºÎ¬ â‚¬)</label>
            <input type="number" step="0.01" name="labor_cost" value="{{ service.labor_cost if service else 0 }}" style="font-weight: bold; color: #2c3e50;">
        </div>

        <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid #eee;">
            {% if service %}
                <a href="{{ url_for('services.service_delete', id=service.id) }}" class="btn-danger" onclick="return confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î±Ï…Ï„ÏŒ Ï„Î¿ service;')">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î®</a>
            {% else %}
                <a href="{{ url_for('services.services_list') }}" class="btn-cancel">Î‘ÎºÏÏÏ‰ÏƒÎ·</a>
            {% endif %}
            
            <button type="submit" class="btn-save">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        </div>
    </form>
</div>

<!-- DATA LISTS Î“Î™Î‘ AUTOCOMPLETE -->
<!-- Î‘Ï…Ï„Î¬ Î³ÎµÎ¼Î¯Î¶Î¿Ï…Î½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ -->
<datalist id="parts_codes">
    {% for p in parts_list %}
        <option value="{{ p.code }}">{{ p.description }}</option>
    {% endfor %}
</datalist>

<datalist id="parts_descriptions">
    {% for p in parts_list %}
        <option value="{{ p.description }}">ÎšÏ‰Î´: {{ p.code }}</option>
    {% endfor %}
</datalist>

{% endblock %}

{% block scripts %}
<script>
    function addRow() {
        const table = document.getElementById('partsTable').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        
        // Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: Î ÏÎ¿ÏƒÎ¸Î­ÏƒÎ±Î¼Îµ Ï„Î± attributes list="..." ÎºÎ±Î¹ ÏƒÏ„Î± Î½Î­Î± Ï€ÎµÎ´Î¯Î± Ï€Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ½Ï„Î±Î¹ Î¼Îµ JS
        newRow.innerHTML = `
            <td><input type="text" name="part_code[]" list="parts_codes" placeholder="ÎšÏ‰Î´."></td>
            <td><input type="text" name="part_description[]" list="parts_descriptions" required placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®..."></td>
            <td><input type="number" step="0.01" name="qty[]" value="1" required style="text-align: center;"></td>
            <td><input type="number" step="0.01" name="unit_price[]" value="0" required></td>
            <td style="text-align: center;"><button type="button" onclick="removeRow(this)" class="btn-del-row">ğŸ—‘ï¸</button></td>
        `;
    }

    function removeRow(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î½Î­Î¿ service Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎ¿Ï…Î¼Îµ Î¼Î¹Î± ÎºÎµÎ½Î® Î³ÏÎ±Î¼Î¼Î® ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®
    const isNewService = "{{ 'true' if not service else 'false' }}" === "true";

    if (isNewService) {
        document.addEventListener("DOMContentLoaded", function() {
            const tbody = document.getElementById('partsTable').getElementsByTagName('tbody')[0];
            if(tbody.rows.length === 0) {
                addRow();
            }
        });
    }
</script>
{% endblock %}
